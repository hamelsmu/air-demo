<!doctype html>
<html>
<head>
    <title>TipTap Editor - Air Demo</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/htmx.org@2.0.0"></script>
    <script type="module">
        import { Editor } from 'https://cdn.jsdelivr.net/npm/@tiptap/core@2.10.3/+esm';
        import StarterKit from 'https://cdn.jsdelivr.net/npm/@tiptap/starter-kit@2.10.3/+esm';
        
        window.initEditor = function(container, initialHTML) {
            const editor = new Editor({
                element: container,
                extensions: [StarterKit],
                content: initialHTML || '<p>Start writing your document...</p>',
                editorProps: { attributes: { class: 'tiptap' } },
                // Sync editor content to hidden field on every change
                // TipTap stores content in the DOM, not in a form field, so we
                // keep the hidden field updated so it's included when the form submits
                onUpdate: ({ editor }) => {
                    document.getElementById('editor-content').value = editor.getHTML();
                }
            });
            
            // Wire up toolbar buttons - each button's data-action maps to a TipTap command
            const toolbar = container.parentElement.querySelector('.button-group');
            if (toolbar) {
                const actions = {
                    bold: () => editor.chain().focus().toggleBold().run(),
                    italic: () => editor.chain().focus().toggleItalic().run(),
                    strike: () => editor.chain().focus().toggleStrike().run(),
                    code: () => editor.chain().focus().toggleCode().run(),
                    h1: () => editor.chain().focus().toggleHeading({ level: 1 }).run(),
                    h2: () => editor.chain().focus().toggleHeading({ level: 2 }).run(),
                    h3: () => editor.chain().focus().toggleHeading({ level: 3 }).run(),
                    'bullet-list': () => editor.chain().focus().toggleBulletList().run(),
                    'ordered-list': () => editor.chain().focus().toggleOrderedList().run(),
                    'code-block': () => editor.chain().focus().toggleCodeBlock().run(),
                    blockquote: () => editor.chain().focus().toggleBlockquote().run(),
                    undo: () => editor.chain().focus().undo().run(),
                    redo: () => editor.chain().focus().redo().run()
                };
                
                Object.keys(actions).forEach(action => {
                    toolbar.querySelector(`[data-action="${action}"]`).onclick = actions[action];
                });
                
                // Update button states (active/disabled) when content or cursor position changes
                editor.on('update', () => updateToolbarState(editor, toolbar));
                editor.on('selectionUpdate', () => updateToolbarState(editor, toolbar));
                updateToolbarState(editor, toolbar);
            }
        };
        
        function updateToolbarState(editor, toolbar) {
            toolbar.querySelector('[data-action="bold"]').classList.toggle('is-active', editor.isActive('bold'));
            toolbar.querySelector('[data-action="italic"]').classList.toggle('is-active', editor.isActive('italic'));
            toolbar.querySelector('[data-action="strike"]').classList.toggle('is-active', editor.isActive('strike'));
            toolbar.querySelector('[data-action="code"]').classList.toggle('is-active', editor.isActive('code'));
            toolbar.querySelector('[data-action="h1"]').classList.toggle('is-active', editor.isActive('heading', { level: 1 }));
            toolbar.querySelector('[data-action="h2"]').classList.toggle('is-active', editor.isActive('heading', { level: 2 }));
            toolbar.querySelector('[data-action="h3"]').classList.toggle('is-active', editor.isActive('heading', { level: 3 }));
            toolbar.querySelector('[data-action="bullet-list"]').classList.toggle('is-active', editor.isActive('bulletList'));
            toolbar.querySelector('[data-action="ordered-list"]').classList.toggle('is-active', editor.isActive('orderedList'));
            toolbar.querySelector('[data-action="code-block"]').classList.toggle('is-active', editor.isActive('codeBlock'));
            toolbar.querySelector('[data-action="blockquote"]').classList.toggle('is-active', editor.isActive('blockquote'));
            toolbar.querySelector('[data-action="undo"]').disabled = !editor.can().undo();
            toolbar.querySelector('[data-action="redo"]').disabled = !editor.can().redo();
        }
        
        // Initialize all TipTap editors on the page
        // This runs on page load AND after HTMX swaps new content in
        // (e.g., when you click "Load" and a new editor form is inserted)
        function initAllEditors() {
            document.querySelectorAll('[data-tiptap]:not([data-initialized])').forEach(container => {
                container.setAttribute('data-initialized', 'true');
                const initialHtml = container.dataset.initialHtml;
                window.initEditor(container, initialHtml ? JSON.parse(initialHtml) : null);
            });
        }
        
        document.addEventListener('DOMContentLoaded', initAllEditors);
        document.body.addEventListener('htmx:afterSwap', initAllEditors);
    </script>
</head>
<body>
    <div id="app">
        <h1>TipTap Rich Text Editor</h1>
        
        <div id="status"></div>
        
        <div id="editor-form">
            <form hx-post="/save" hx-target="#status">
                <input name="title" type="text" required placeholder="Document Title" />
                
                <div class="control-group">
                    <div class="button-group">
                        <button type="button" data-action="bold">Bold</button>
                        <button type="button" data-action="italic">Italic</button>
                        <button type="button" data-action="strike">Strike</button>
                        <button type="button" data-action="code">Code</button>
                        <button type="button" data-action="h1">H1</button>
                        <button type="button" data-action="h2">H2</button>
                        <button type="button" data-action="h3">H3</button>
                        <button type="button" data-action="bullet-list">Bullet list</button>
                        <button type="button" data-action="ordered-list">Ordered list</button>
                        <button type="button" data-action="code-block">Code block</button>
                        <button type="button" data-action="blockquote">Blockquote</button>
                        <button type="button" data-action="undo">Undo</button>
                        <button type="button" data-action="redo">Redo</button>
                    </div>
                    <div class="editor-container" data-tiptap=""></div>
                </div>
                
                <input name="content" type="hidden" id="editor-content" />
                <button type="submit" class="primary">Save Document</button>
            </form>
        </div>

        <div class="document-list">
            <h2>Saved Documents</h2>
            <div id="documents">
                {% for d in documents %}
                <div class="document-item">
                    <h3>{{ d.title }}</h3>
                    <p>Last updated: {{ d.updated_at[:19] }}</p>
                    <button hx-get="/load/{{ d.id }}" hx-target="#editor-form" hx-swap="outerHTML">Load</button>
                    <button hx-delete="/delete/{{ d.id }}" hx-target="#status" hx-confirm="Delete '{{ d.title }}'?">Delete</button>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</body>
</html>
