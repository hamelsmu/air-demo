<!doctype html>
<html>
<head>
    <title>TipTap Editor - Air Demo</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/htmx.org@2.0.0"></script>
    <script type="module">
        import { Editor } from 'https://cdn.jsdelivr.net/npm/@tiptap/core@2.10.3/+esm';
        import StarterKit from 'https://cdn.jsdelivr.net/npm/@tiptap/starter-kit@2.10.3/+esm';
        
        window.initEditor = function(container, initialHTML) {
            const form = container.closest('form');
            const hiddenField = form?.querySelector('input[name="content"]');
            
            const editor = new Editor({
                element: container,
                extensions: [StarterKit],
                content: initialHTML || '<p>Start writing your document...</p>',
                editorProps: { attributes: { class: 'tiptap' } },
                // Sync editor content to hidden field on every change
                // TipTap stores content in the DOM, not in a form field, so we
                // keep the hidden field updated so it's included when the form submits
                onUpdate: ({ editor }) => {
                    if (hiddenField) hiddenField.value = editor.getHTML();
                }
            });
            
            // Wire up toolbar buttons using event delegation
            const toolbar = container.parentElement.querySelector('.button-group');
            if (toolbar) {
                // Map button actions to editor commands
                const runAction = (action) => {
                    const chain = editor.chain().focus();
                    switch (action) {
                        case 'bold': case 'italic': case 'strike': 
                        case 'code': case 'blockquote':
                            chain[`toggle${action.charAt(0).toUpperCase() + action.slice(1)}`]().run();
                            break;
                        case 'h1': chain.toggleHeading({ level: 1 }).run(); break;
                        case 'h2': chain.toggleHeading({ level: 2 }).run(); break;
                        case 'h3': chain.toggleHeading({ level: 3 }).run(); break;
                        case 'bullet-list': chain.toggleBulletList().run(); break;
                        case 'ordered-list': chain.toggleOrderedList().run(); break;
                        case 'code-block': chain.toggleCodeBlock().run(); break;
                        case 'undo': chain.undo().run(); break;
                        case 'redo': chain.redo().run(); break;
                    }
                };
                
                // Single click handler for all toolbar buttons
                toolbar.addEventListener('click', (e) => {
                    const btn = e.target.closest('[data-action]');
                    if (btn && !btn.disabled) runAction(btn.dataset.action);
                });
                
                // Update button states (active/disabled) when content or cursor position changes
                const updateToolbar = () => {
                    // Config for active state checks
                    const activeStates = {
                        bold: ['bold'],
                        italic: ['italic'],
                        strike: ['strike'],
                        code: ['code'],
                        h1: ['heading', { level: 1 }],
                        h2: ['heading', { level: 2 }],
                        h3: ['heading', { level: 3 }],
                        'bullet-list': ['bulletList'],
                        'ordered-list': ['orderedList'],
                        'code-block': ['codeBlock'],
                        blockquote: ['blockquote']
                    };
                    
                    Object.entries(activeStates).forEach(([action, args]) => {
                        const btn = toolbar.querySelector(`[data-action="${action}"]`);
                        if (btn) btn.classList.toggle('is-active', editor.isActive(...args));
                    });
                    
                    const undoBtn = toolbar.querySelector('[data-action="undo"]');
                    const redoBtn = toolbar.querySelector('[data-action="redo"]');
                    if (undoBtn) undoBtn.disabled = !editor.can().undo();
                    if (redoBtn) redoBtn.disabled = !editor.can().redo();
                };
                
                editor.on('update', updateToolbar);
                editor.on('selectionUpdate', updateToolbar);
                updateToolbar();
            }
        };
        
        // Initialize all TipTap editors on the page
        // This runs on page load AND after HTMX swaps new content in
        // (e.g., when you click "Load" and a new editor form is inserted)
        function initAllEditors() {
            document.querySelectorAll('[data-tiptap]:not([data-initialized])').forEach(container => {
                container.dataset.initialized = 'true';
                const initialHtml = container.dataset.initialHtml;
                window.initEditor(container, initialHtml ? JSON.parse(initialHtml) : null);
            });
        }
        
        document.addEventListener('DOMContentLoaded', initAllEditors);
        document.body.addEventListener('htmx:afterSwap', initAllEditors);
    </script>
</head>
<body>
    <div id="app">
        <h1>TipTap Rich Text Editor</h1>
        
        <div id="status"></div>
        
        <div id="editor-form">
            <form hx-post="/save" hx-target="#status">
                <input name="title" type="text" required placeholder="Document Title" />
                
                <div class="control-group">
                    <div class="button-group">
                        <button type="button" data-action="bold">Bold</button>
                        <button type="button" data-action="italic">Italic</button>
                        <button type="button" data-action="strike">Strike</button>
                        <button type="button" data-action="code">Code</button>
                        <button type="button" data-action="h1">H1</button>
                        <button type="button" data-action="h2">H2</button>
                        <button type="button" data-action="h3">H3</button>
                        <button type="button" data-action="bullet-list">Bullet list</button>
                        <button type="button" data-action="ordered-list">Ordered list</button>
                        <button type="button" data-action="code-block">Code block</button>
                        <button type="button" data-action="blockquote">Blockquote</button>
                        <button type="button" data-action="undo">Undo</button>
                        <button type="button" data-action="redo">Redo</button>
                    </div>
                    <div class="editor-container" data-tiptap=""></div>
                </div>
                
                <input name="content" type="hidden" id="editor-content" />
                <button type="submit" class="primary">Save Document</button>
            </form>
        </div>

        <div class="document-list">
            <h2>Saved Documents</h2>
            <div id="documents">
                {% include 'documents-list.html' %}
            </div>
        </div>
    </div>
</body>
</html>
